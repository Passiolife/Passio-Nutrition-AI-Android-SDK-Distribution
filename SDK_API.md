# Passio SDK API

## Version 0.12.0

```kotlin
typealias PassioID = String

typealias UPCCode = String
typealias Barcode = String
typealias OCRCode = String

typealias FileName = String

data class FoodCandidates(
    val detectedCandidates: List<DetectedCandidate>? = null,
    val logoCandidates: List<ObjectDetectionCandidate>? = null,
    val barcodeCandidates: List<BarcodeCandidate>? = null,
    val ocrCandidates: List<OCRCode>? = null
)

class DetectedCandidate(
    val passioID: PassioID,
    val confidence: Float,
    val boundingBox: RectF,
    val croppedImage: Bitmap?
)

open class ClassificationCandidate(var passioID: PassioID, val confidence: Float)

class ObjectDetectionCandidate(
    passioID: PassioID,
    confidence: Float,
    val boundingBox: RectF
) : ClassificationCandidate(passioID, confidence)


data class BarcodeCandidate(val barcode: Barcode, val boundingBox: RectF)

interface FoodRecognitionListener {
    fun onRecognitionResults(
        candidates: FoodCandidates,
        image: Bitmap?,
        nutritionFacts: PassioNutritionFacts?
    )
}

interface ObjectDetectionListener {
    fun onObjectDetectionResult(candidates: List<ObjectDetectionCandidate>)
}

interface ClassificationListener {
    fun onClassificationResult(candidates: List<ClassificationCandidate>)
}

interface BarcodeDetectionListener {
    fun onBarcodeResult(barcodes: List<BarcodeCandidate>)
}

interface OCRListener {
    fun onTextDetected(detectedText: String)
    fun onOCRResult(detectedOCRCode: OCRCode?, confidence: Float)
}

interface PassioDownloadListener {
    fun onCompletedDownloadingAllFiles(fileUris: List<Uri>)
    fun onCompletedDownloadingFile(fileUri: Uri, filesLeft: Int)
    fun onDownloadError(message: String)
}

interface PassioStatusListener {
    fun onPassioStatusChanged(status: PassioStatus)
}

private const val MINIMUM_CONFIDENCE_TF_OD_API = 0.33f

private const val MINIMUM_CONFIDENCE_TF_OD_API = 0.33f

interface PassioSDK {

    enum class FramesPerSecond {
        ONE,
        TWO,
        MAX
    }

    companion object {
        val instance: PassioSDK
            get() {
                if (internalInstance == null) {
                    internalInstance = PassioSDKImpl()
                }
                return internalInstance!!
            }
    }

    /**
     * Initializes the SDK with the given [passioConfiguration]. See [PassioConfiguration] for more
     * information on the different types of SDK configuration. The initialization process includes
     * downloading or reading a cached version of the license and loading the models into the
     * TensorFlowLite runner. This process is being executed on a background thread, but the
     * callback with the result of the configuration process will be called on the main thread. You
     * may call [startCamera] or [startFoodDetection] before this method, there is no need to wait
     * the [onComplete] callback.
     *
     * @param passioConfiguration the input configuration for the SDK.
     * @param onComplete the callback that will be called at the end of the configuration process
     *        with the result in the form of the {@link ai.passio.passiosdk.core.config.PassioStatus}
     */
    fun configure(
        passioConfiguration: PassioConfiguration,
        onComplete: (status: PassioStatus) -> Unit
    )

    /**
     * Initializes the SDK with the given [developerKey] and the correct models from the assets
     * folder. Developer key must be 42 character key generated by Passio Inc. For obtaining this
     * key contact support@passiolife.com. The initialization process includes downloading or
     * reading a cached version of the license, loading the models into the TensorFlowLite runner.
     * This process is being executed on a background thread, but the calls to the error or success
     * lambdas will be called on the main thread. You may call [startCamera] before this method,
     * there is no need to wait the [onSDKReady] call.
     *
     * @param context needed to download and store licenses.
     * @param developerKey 42 long string key that servers as a license.
     * @param onSDKError lambda that will be called if there was an error during the initialization
     *        process of the SDK. The errorMessage will provide detailed information about the
     *        error.
     * @param onSDKReady lambda that will be called if the initialization process completed as
     *        successful.
     */
    fun configure(
        context: Context,
        developerKey: String,
        onSDKError: (errorMessage: String) -> Unit,
        onSDKReady: () -> Unit = {}
    )

    /**
     * Checks whether the SDK initialization ran to completion. The initialization process starts
     * with the [configure] function.
     *
     * @return true if the SDK has initialized without errors, false instead.
     */
    fun isSDKReady(): Boolean

    /**
     * Starts the camera preview with the given [PassioCameraViewProvider]. Using CameraX
     * (https://developer.android.com/training/camerax), the camera system will start rendering
     * the frames onto the PreviewView. Also this method binds the camera with the lifecycle
     * provider of the CameraViewProvider. When that lifecycle provider calls onStart() the
     * camera preview will start and when it calls onStop() the camera preview will stop and
     * start the shutdown process. [android.view.Surface.ROTATION_]
     *
     * @param passioCameraViewProvider provides the PreviewView to render the camera frames, the
     *        lifecycle holder which will start and stop the camera, and also the context provider
     *        needed to open the camera.
     * @param displayRotation if the orientation changes are enabled, use this parameter to notify
     *        the camera of the display rotation. Accepted values are: Surface.ROTATION_0,
     *        Surface.ROTATION_90, Surface.ROTATION_180, Surface.ROTATION_270.
     * @param tapToFocus set true to enable a tap listener on the passioCameraViewProvider's
     *        PreviewView that will start a manual focus operation.
     */
    fun startCamera(
        passioCameraViewProvider: PassioCameraViewProvider,
        displayRotation: Int = 0,
        tapToFocus: Boolean = false
    )

    /**
     * Turns the device's flashlight on or off.
     *
     * @param enabled if enabled is set to true, it will turn the flashlight on. If the enabled
     *        parameter is the to false, it will turn the flashlight off.
     */
    fun enableFlashlight(enabled: Boolean)

    /**
     * Sets the time between each analyzed frame. For example, it the [timeForAnalysis] is set to
     * 500L (0.5 seconds), the camera engine will analyze 2 frames per second. If set to 0L, the
     * camera will analyze frames as fast as possible. If the time is smaller than the time it takes
     * to analyze and process the frame, the SDK will work as if set to 0L. The default is set to
     * 1000L (1 second).
     *
     * @param timeForAnalysis the time passed between two frames that are being analyzed.
     */
    fun runFrameEvery(timeForAnalysis: Long)

    /**
     * Finalizes the PassioSDK instance. Deallocates the memory reserved for TFLite models,
     * transformation matrices and shuts down all the background queues that power the SDK. To run
     * the SDK again, [configure] must be called.
     */
    fun shutDownPassioSDK() {
        internalInstance = null
    }

    /**
     * Registers a listener for the food detection process. The results will be returned at a
     * frequency defined in the [FoodDetectionConfiguration.framesPerSecond] field.
     *
     * @param foodRecognitionListener the interface that serves as a callback for the recognition
     *        results.
     * @param detectionConfig an object that defines what to recognize, how often, and other
     *        recognition properties.
     *
     */
    fun startFoodDetection(
        foodRecognitionListener: FoodRecognitionListener,
        detectionConfig: FoodDetectionConfiguration = FoodDetectionConfiguration()
    )

    /**
     * Stops the food detection process. After this method is called no results should be delivered
     * to a previously registered [FoodRecognitionListener].
     */
    fun stopFoodDetection()

    /**
     * Runs object detection on a given [Bitmap]. The process will run on the same background
     * thread as object detection process from the [startFoodDetection] method. The results will
     * be delivered on the main thread. [viewWidth] and [viewHeight] are used to calculate the
     * correct bounding boxes of the recognized items.
     *
     * @param bitmap image to analyze
     * @param onDetectionCompleted callback for the results of the detection process.
     */
    fun detectFoodIn(
        bitmap: Bitmap,
        foodDetectionConfiguration: FoodDetectionConfiguration? = null,
        onDetectionCompleted: (candidates: FoodCandidates?) -> Unit
    )

    /**
     * For a given [PassioID] returns the corresponding image from the SDK's asset folder.
     *
     * @param context used to open assets
     * @param passioID key to find the image
     * @return if the [passioID] is valid returns the [Drawable] from the assets. If not returns null.
     */
    fun lookupImageFor(context: Context, passioID: PassioID): Drawable?

    /**
     * For a given [imageName] returns the corresponding image from the SDK's asset folder.
     *
     * @param context used to open assets
     * @param imageName name of the image resource
     * @return if the image with the given [imageName] exists returns the [Drawable] from the assets.
     *         If not returns null.
     */
    fun lookupImageForFilename(context: Context, imageName: String): Drawable?

    /**
     * For a given [PassioID] returns the name of corresponding food item.
     *
     * @param passioID the ID of the food item
     * @return name of the food item if there is a an object in the nutritional database with the
     *         provided passioID, null otherwise.
     */
    fun lookupNameFor(passioID: PassioID): String?

    /**
     * For a given [PassioID] returns the [PassioIDAttributes] of that food item.
     *
     * @param passioID the ID of the food item
     * @return attributes object that represent all of the nutritional data the SDK has on a food
     *         item corresponding to the passioID, null otherwise.
     */
    fun lookupPassioAttributesFor(passioID: PassioID): PassioIDAttributes?

    fun lookupPassioAttributesForName(name: String): PassioIDAttributes?

    /**
     * For a given food item name returns the [PassioID] if the item exists in the SDK's nutritional
     * database. If it doesn't exist returns null.
     *
     * @param name the name of the food
     * @return [PassioID] of the food from the nutritional database, null otherwise.
     */
    fun lookupPassioIDFor(name: String): PassioID?

    /**
     * For a given [PassioID] returns a list of all the alternatives for this food items. That list
     * includes parent and children food items.
     *
     * @param passioID the ID of the food item
     * @return list of all of the hierarchically connected [PassioID]s of the food item that
     *         corresponds to the given passioID, null otherwise.
     */
    fun lookupAlternativesFor(passioID: PassioID): List<PassioID>?

    /**
     * For a given [passioID] returns a list that contains the subtree of the food hierarchy that
     * has the food item with the given [passioID] as a root.
     *
     * @param passioID the ID of the food item
     * @return list that represents the subtree of the given [passioID], null otherwise.
     */
    fun lookupAllDescendantsFor(passioID: PassioID): List<PassioID>?

    /**
     * For a given [passioID] returns a list that contains all of the nodes the food hierarchy that
     * have the same parent as of the food item of the [passioID].
     *
     * @param passioID the ID of the food item
     * @return list that represents the siblings of the given [passioID], null otherwise.
     */
    fun lookupAllSiblingsFor(passioID: PassioID): List<PassioID>?

    /**
     * For a given [passioID] returns a list that contains all of the nodes the food hierarchy that
     * have the same parent as of the food item of the [passioID].
     *
     * @param passioID the ID of the food item
     * @return list that represents the siblings of the given [passioID], null otherwise.
     */
    fun lookupParentFor(passioID: PassioID): PassioID?

    /**
     * Returns a list of all food items from the nutritional database.
     */
    fun lookupAllFoodItemsInDatabase(): List<String>


    /**
     * Returns a list of all [PassioID]s from the nutritional database.
     */
    fun lookupAllPassioIDs(): Map<PassioID, String>

    /**
     * Returns a list of all [PassioID]s that can be recognized by our recognition engine.
     */
    fun lookupAllVisuallyRecognizableFoodItems(): List<String>

    fun searchForFood(byText: String): List<String>

    fun fetchPassioIDAttributesForBarcode(
        barcode: Barcode,
        onAttributesFetched: (passioIDAttributes: PassioIDAttributes?) -> Unit
    )

    fun fetchPassioIDAttributesForOCRCode(
        ocrcode: OCRCode,
        onAttributesFetched: (passioIDAttributes: PassioIDAttributes?) -> Unit
    )

    fun setDownloadListener(downloadListener: PassioDownloadListener?)

    fun setStatusListener(statusListener: PassioStatusListener?)

    fun boundingBoxToViewTransform(
        boundingBox: RectF,
        viewWidth: Int,
        viewHeight: Int,
        displayAngle: Int = 0,
        barcode: Boolean = false
    ): RectF

}
```

<sup>Copyright 2020 Passio Inc</sup>
